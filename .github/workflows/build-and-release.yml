name: FandTpaPlus CI/CD

on:
  push:
    branches: [ "master", "main" ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - pre-release
          - draft

permissions:
  contents: write
  actions: read
  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      jar-name: ${{ steps.build-info.outputs.jar-name }}
      should-release: ${{ steps.check-release.outputs.should-release }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æå–ç‰ˆæœ¬ä¿¡æ¯
        id: extract-version
        run: |
          # ä» build.gradle.kts æå–ç‰ˆæœ¬
          VERSION=$(grep -E "^version\s*=\s*" build.gradle.kts | sed 's/version\s*=\s*"\(.*\)"/\1/')
          
          # å¦‚æœæ˜¯å¿«ç…§ç‰ˆæœ¬ï¼Œæ·»åŠ æ„å»ºå·
          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
            FULL_VERSION="${VERSION}-build.${BUILD_NUMBER}"
          else
            FULL_VERSION="$VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "full-version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "::notice::æ’ä»¶ç‰ˆæœ¬: $VERSION (å®Œæ•´ç‰ˆæœ¬: $FULL_VERSION)"

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: ğŸ”§ è®¾ç½® Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: |
          chmod +x gradlew
          ./gradlew clean build --no-daemon --stacktrace

      - name: ğŸ“¦ å‡†å¤‡æ„å»ºäº§ç‰©
        id: build-info
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ JAR æ–‡ä»¶
          JAR_FILE=$(find build/libs -name "FandTpaPlus-*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "::error::æœªæ‰¾åˆ°æ„å»ºäº§ç‰©!"
            exit 1
          fi
          
          # é‡å‘½åä¸ºæ›´æ¸…æ™°çš„åç§°
          VERSION="${{ steps.extract-version.outputs.version }}"
          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            NEW_NAME="FandTpaPlus-${{ steps.extract-version.outputs.full-version }}.jar"
          else
            NEW_NAME="FandTpaPlus-${VERSION}.jar"
          fi
          
          cp "$JAR_FILE" "$NEW_NAME"
          
          echo "jar-name=$NEW_NAME" >> $GITHUB_OUTPUT
          echo "::notice::æ„å»ºäº§ç‰©: $NEW_NAME (å¤§å°: $(ls -lh $NEW_NAME | awk '{print $5}'))"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: ./gradlew test --no-daemon
        continue-on-error: true

      - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: JUnit æµ‹è¯•æŠ¥å‘Š
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: false

      - name: ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: FandTpaPlus-${{ steps.extract-version.outputs.full-version }}
          path: ${{ steps.build-info.outputs.jar-name }}
          retention-days: 30

      - name: ğŸ·ï¸ æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒ
        id: check-release
        run: |
          # æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ›å»ºå‘å¸ƒ
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
          fi

  release:
    needs: build
    if: needs.build.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: FandTpaPlus-${{ needs.build.outputs.version }}

      - name: ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # è·å–æœ€æ–°çš„æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            # å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œè·å–æ‰€æœ‰æäº¤
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # è·å–è‡ªä¸Šä¸ªæ ‡ç­¾ä»¥æ¥çš„æäº¤
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          cat > RELEASE_NOTES.md << EOF
          ## ğŸ‰ FandTpaPlus ${{ needs.build.outputs.version }}
          
          ### ğŸ“… å‘å¸ƒæ—¥æœŸ
          $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - å®Œæ•´çš„TPAä¼ é€ç³»ç»Ÿ
          - å¤šå®¶(Home)æ”¯æŒ
          - è¿”å›(Back)åŠŸèƒ½
          - ç§°å·ç³»ç»Ÿ
          - è®¡åˆ†æ¿å’ŒTabåˆ—è¡¨
          - å®Œå…¨æ”¯æŒFolia
          - è‡ªåŠ¨æ›´æ–°æ£€æŸ¥
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          ${COMMITS}
          
          ### ğŸ“¦ ä¸‹è½½
          - **æ–‡ä»¶å**: \`${{ needs.build.outputs.jar-name }}\`
          - **æ”¯æŒç‰ˆæœ¬**: Paper/Spigot/Folia 1.21.4+
          - **Javaç‰ˆæœ¬**: 21+
          
          ### ğŸš€ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ \`${{ needs.build.outputs.jar-name }}\`
          2. å°†æ–‡ä»¶æ”¾å…¥æœåŠ¡å™¨çš„ \`plugins\` ç›®å½•
          3. é‡å¯æœåŠ¡å™¨
          4. ç¼–è¾‘ \`plugins/FandTpaPlus/config.yml\` è¿›è¡Œé…ç½®
          
          ### ğŸ“– æ–‡æ¡£
          - [å‘½ä»¤åˆ—è¡¨](https://github.com/${{ github.repository }}/wiki/Commands)
          - [æƒé™èŠ‚ç‚¹](https://github.com/${{ github.repository }}/wiki/Permissions)
          - [é…ç½®æ–‡ä»¶](https://github.com/${{ github.repository }}/wiki/Configuration)
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢åé¦ˆã€‚
          EOF
          
          echo "notes_file=RELEASE_NOTES.md" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ ç¡®å®šå‘å¸ƒç±»å‹
        id: release-type
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          
          # æ ¹æ®ç‰ˆæœ¬å·ç¡®å®šå‘å¸ƒç±»å‹
          if [[ "$VERSION" == *"-SNAPSHOT"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "tag=dev-${{ needs.build.outputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-alpha"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "tag=v${{ needs.build.outputs.version }}" >> $GITHUB_OUTPUT
          else
            # æ­£å¼ç‰ˆæœ¬
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„å‘å¸ƒç±»å‹
              case "${{ github.event.inputs.release_type }}" in
                "pre-release")
                  echo "prerelease=true" >> $GITHUB_OUTPUT
                  echo "draft=false" >> $GITHUB_OUTPUT
                  ;;
                "draft")
                  echo "prerelease=false" >> $GITHUB_OUTPUT
                  echo "draft=true" >> $GITHUB_OUTPUT
                  ;;
                *)
                  echo "prerelease=false" >> $GITHUB_OUTPUT
                  echo "draft=false" >> $GITHUB_OUTPUT
                  ;;
              esac
            else
              echo "prerelease=false" >> $GITHUB_OUTPUT
              echo "draft=false" >> $GITHUB_OUTPUT
            fi
            echo "tag=v${{ needs.build.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ${{ needs.build.outputs.jar-name }}
          tag_name: ${{ steps.release-type.outputs.tag }}
          name: "FandTpaPlus ${{ needs.build.outputs.version }}"
          body_path: ${{ steps.changelog.outputs.notes_file }}
          prerelease: ${{ steps.release-type.outputs.prerelease }}
          draft: ${{ steps.release-type.outputs.draft }}
          generate_release_notes: false

      - name: ğŸ“¢ å‘å¸ƒé€šçŸ¥
        if: success()
        run: |
          echo "::notice::ğŸ‰ æˆåŠŸå‘å¸ƒ FandTpaPlus ${{ needs.build.outputs.version }}!"
          echo "::notice::ğŸ“¦ ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release-type.outputs.tag }}"